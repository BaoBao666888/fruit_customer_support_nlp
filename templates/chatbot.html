{% extends "base.html" %}
{% block title %}Chatbot Tr√°i C√¢y{% endblock %}

{% block content %}
<h2 class="text-center mb-4">ü§ñ Tr√≤ chuy·ªán v·ªõi Tr·ª£ L√Ω Tr√°i C√¢y</h2>

<div class="d-flex justify-content-center">
    <div class="card shadow p-3 w-100" style="max-width: 720px;">
        <div id="chatBox" class="bg-light p-3 rounded" style="height: 400px; overflow-y: auto;"></div>

        <div class="input-group mt-3">
            <input type="text" id="userInput" class="form-control" placeholder="H·ªèi v·ªÅ tr√°i c√¢y..." required>
            <button class="btn btn-primary" type="button" onclick="sendMessage()">G·ª≠i</button>
        </div>
    </div>
</div>

<script>
    function appendMessage(sender, text, styleClass = '', id = null) {
        const chatBox = document.getElementById("chatBox");
        const msg = document.createElement("div");
        msg.classList.add("mb-3");
        msg.innerHTML = `
            <div class="d-flex mb-1">
                <div class="me-2"><span class="badge ${styleClass}">${sender}</span></div>
                <div class="bg-white border rounded p-2 w-100">${text}</div>
            </div>`;
        if (id) msg.id = id;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById("userInput");
        const userText = input.value.trim();
        if (!userText) return;

        appendMessage("üë§ B·∫°n", userText, "bg-primary");

        // Th√™m bubble Bot ƒëang tr·∫£ l·ªùi...
        const loadingId = "bot-loading";
        appendMessage("ü§ñ Bot", '<i class="fas fa-spinner fa-spin text-muted"></i> ƒêang tr·∫£ l·ªùi...', "bg-secondary", loadingId);

        fetch("/chat_api", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: userText })
        })
        .then(res => res.json())
        .then(data => {
            // X√≥a bubble loading
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();

            // Th√™m ph·∫£n h·ªìi th·∫≠t s·ª±
            appendMessage("ü§ñ Bot", data.response, "bg-success");
        });

        input.value = "";
        input.focus();
    }

    document.getElementById("userInput").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
{% endblock %}
